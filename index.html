
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quick Chat</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <div id="terminal-login">
    <div class="terminal-line">login: <input type="text" id="terminal-username" autofocus></div>
    <div class="terminal-line password-line" style="display: none;">password: <input type="password" id="terminal-password"></div>
  </div>

  <div id="auth-container">
    <h2>Enter Secret Code</h2>
    <input type="text" id="secret-code" placeholder="Enter secret code" />
    <button id="submit-code" onclick="checkSecretCode()">Submit</button>
  </div>

  <div id="chat" style="display:none;">
    <div id="messages"></div>
    <div class="input-area">
      <input type="text" id="message" placeholder="Type a message ðŸ˜Š" autocomplete="off">
      <button id="send-btn" title="Send">&#10148;</button>
      <button id="clear-btn" title="Clear">&#128465;</button>
    </div>
  </div>

<script>
  const socket = io();
  let userName = '';
  let messageMap = {};

  // Step 1: Handle terminal-style login
  document.getElementById("terminal-username").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      document.querySelector(".password-line").style.display = "block";
      document.getElementById("terminal-password").focus();
    }
  });

  document.getElementById("terminal-password").addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      const user = document.getElementById("terminal-username").value.trim();
      const pass = document.getElementById("terminal-password").value.trim();

      if (user && pass && user === "admin" && pass === "pass123") {
        userName = user;
        document.getElementById("terminal-login").style.display = "none";
        document.getElementById("auth-container").style.display = "flex";
      } else {
        alert("Login failed. Try again.");
        location.reload();
      }
    }
  });

  // Step 2: Secret code verification
  function checkSecretCode() {
    const secretCode = document.getElementById('secret-code').value.trim();
    if (secretCode === "RSS") {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('chat').style.display = 'flex';
      socket.emit('set name', { name: userName });
    } else {
      alert("Incorrect secret code. Please try again.");
    }
  }

  // Chat send
  document.getElementById('send-btn').addEventListener('click', () => {
    const msgInput = document.getElementById('message');
    const msg = msgInput.value.trim();
    if (msg) {
      const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const messageId = Date.now().toString() + Math.random().toString(36).substring(2);
      const messageData = { id: messageId, sender: userName, msg, time: timestamp, status: 'sent' };
      socket.emit('chat message', messageData);
      renderMessage(messageData, true);
      messageMap[messageId] = messageData;
      msgInput.value = '';
    }
  });

  // Clear chat
  document.getElementById('clear-btn').addEventListener('click', () => {
    document.getElementById('messages').innerHTML = '';
  });

  function renderMessage(data, isSelf) {
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');
    messageElement.classList.add(data.sender === userName ? 'user' : 'friend');
    messageElement.setAttribute('id', data.id);

    const tickHTML = isSelf
      ? `<span class="status ${data.status}">${getStatusTick(data.status)}</span>`
      : '';

    messageElement.innerHTML = `
      <strong>${data.sender}:</strong> ${data.msg}
      <div class="timestamp">${data.time} ${tickHTML}</div>
    `;
    document.getElementById('messages').prepend(messageElement);
  }

  function getStatusTick(status) {
    switch (status) {
      case 'sent': return 'âœ”';
      case 'delivered': return 'âœ”âœ”';
      case 'seen': return '<span style="color:#25d366;">âœ”âœ”</span>';
      default: return '';
    }
  }

  socket.on('chat message', (data) => {
    if (data.sender === userName) return;
    renderMessage(data, false);
    socket.emit('message delivered', { id: data.id, sender: data.sender });
  });

  socket.on('update status', (data) => {
    const msgEl = document.getElementById(data.id);
    if (msgEl && messageMap[data.id]) {
      messageMap[data.id].status = data.status;
      const timestamp = msgEl.querySelector('.timestamp');
      timestamp.innerHTML = messageMap[data.id].time + ' <span class="status ' + data.status + '">' + getStatusTick(data.status) + '</span>';
    }
  });

  window.addEventListener('focus', () => {
    Object.keys(messageMap).forEach(id => {
      const msg = messageMap[id];
      if (msg.sender !== userName && msg.status !== 'seen') {
        socket.emit('message seen', { id: id, sender: msg.sender });
      }
    });
  });
</script>


</body>
</html>
